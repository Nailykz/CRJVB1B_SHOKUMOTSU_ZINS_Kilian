<!doctype html> 
<html lang="en"> 
<head> 
    <meta charset="UTF-8" />
    <title>Mario like Inchallah j'y arrive</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.11.0/dist/phaser.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>
<script type="text/javascript">

var config = {
    type: Phaser.AUTO,
    width: 896,
    height: 448,
    physics: {
        default: 'arcade',
        arcade:{
            gravity: {y: 0},
            debug:true,
        }
    },
    scene: {
        preload: preload,
        create: create,
        update: update
    }
};

var player;
var cursors;
var caisses
var caisse;
var box;
var wallsLayer;
var gameOver = false;
var death;
var ground;
var Touche_Caisse=false;
var playerDirection="right";
var destroyBox;
var jumpCount=0;
var doublesaut=true;
var jump;
//FEU
var Buta_Feu;
var piment;
var piments;
var lancer_boule_de_feu;
var boules_de_feu;
var destroyFireball;
var BDF_reload = true;
//GLACE
var Buta_Glace;
var glace;
var glaces;
var lancer_boule_de_glace;
var boules_de_glace;
var BDG_reload = true;
//AILE
var Buta_Aile;
var poulet;
var poulets;
var flying_mode;
var Aile_reload = true;
//ALIMENTS
var aliment;
var aliments;
var jauge=0;
var jaugeText;
//ENNEMI
var ennemi;
var ennemis;
var movement=true;
var timeoutDelayMovementEnnemi=15000;
BDG_Touch=false;
//HP
var player_hp = 5;
var invincible = false;
var full_heart_1;
var full_heart_2;
var full_heart_3;
var full_heart_4;
var full_heart_5;
var empty_heart_1;
var empty_heart_2;
var empty_heart_3;
var empty_heart_4;
var empty_heart_5;
var damageOff=true;
//////////////
//CONTROLES
var Haut;
var Bas;
var Gauche;
var Droite;
var Roulade;
var roulade = false;


var game = new Phaser.Game(config);


function preload ()
{
    this.load.image('tiles','assets/tiles/teste.png');
    this.load.image('box','assets/tiles/box.png');
    this.load.image('chilli_pepper','assets/tiles/box.png');
    this.load.image('ice_cream','assets/tiles/box.png');
    this.load.image('boule_de_feu','assets/tiles/box.png');
    this.load.image('boule_de_glace','assets/tiles/box.png');
    this.load.image('poulet','assets/tiles/box.png');
    this.load.image('aliment','assets/tiles/box.png');
    this.load.image('ennemi','assets/tiles/box.png');
    this.load.tilemapTiledJSON('map','assets/tiles/RaionVille.json');
    this.load.image('full_heart', 'assets/full_heart.png');
    this.load.image('empty_heart', 'assets/empty_heart.png');
}

function create ()
{  
    const map = this.make.tilemap({key : 'map'});
    const tileset = map.addTilesetImage('teste','tiles');

    ground = map.createDynamicLayer('Ville',tileset);
    ground.setCollisionByExclusion(-1,true);
    
    player = this.physics.add.sprite(200,1550, 'dude').setScale(1.1);
    full_heart_1 = this.add.sprite(50,30, 'full_heart').setScrollFactor(0).setScale(0.1);
    full_heart_2 = this.add.sprite(100,30, 'full_heart').setScrollFactor(0).setScale(0.1);
    full_heart_3 = this.add.sprite(150,30, 'full_heart').setScrollFactor(0).setScale(0.1);
    full_heart_4 = this.add.sprite(200,30, 'full_heart').setScrollFactor(0).setScale(0.1);
    full_heart_5 = this.add.sprite(250,30, 'full_heart').setScrollFactor(0).setScale(0.1);
        
    empty_heart_1 = this.add.sprite(50,30, 'empty_heart').setVisible(false).setScrollFactor(0).setScale(0.1);
    empty_heart_2 = this.add.sprite(100,30, 'empty_heart').setVisible(false).setScrollFactor(0).setScale(0.1);
    empty_heart_3 = this.add.sprite(150,30, 'empty_heart').setVisible(false).setScrollFactor(0).setScale(0.1);
    empty_heart_4 = this.add.sprite(200,30, 'empty_heart').setVisible(false).setScrollFactor(0).setScale(0.1);
    empty_heart_5 = this.add.sprite(250,30, 'empty_heart').setVisible(false).setScrollFactor(0).setScale(0.1);

    this.cameras.main.startFollow(player);
    
    player.setBounce(0.0);
    player.setCollideWorldBounds(false);

    cursors = this.input.keyboard.createCursorKeys();    
    Jump = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE);  
    Competence_Speciale = this.input.keyboard.addKey('F');
    Roulade = this.input.keyboard.addKey('E');

    this.physics.add.collider(player, ground);
    jaugeText = this.add.text(30,50,'Jauge:0',
    {
        fontSize: '32px', fill: '#FFF'    
    }).setScrollFactor(0);
//CAISSE
    const CaisseObjects = map.getObjectLayer('Caisse').objects;

    this.caisses = this.physics.add.group({
        immovable:true,
        allowGravity:false,
    });

    for (const caisse of CaisseObjects){
            this.caisses.create(caisse.x, caisse.y, 'box')
                .setScale(0.1)
        }

    for (const caisse of this.caisses.children.entries) {
        this.physics.add.collider(caisse, ground);
        this.physics.add.collider(player, caisse, hitByPlayer, null, this);        
    }       
        this.physics.add.collider(this.caisses, this.caisses);

//PIMENT
    const PimentObjects = map.getObjectLayer('Piment').objects;

    this.piments = this.physics.add.group({
        immovable:true,
        allowGravity:false,
    });
    
    for (const piment of PimentObjects){
            this.piments.create(piment.x, piment.y, 'chilli_pepper')
                .setScale(0.1)
        }

    for (const piment of this.piments.children.entries) {
        this.physics.add.collider(piment, ground);
        this.physics.add.overlap(player, piment, Recolte_Piment, null, this);
        
    }       
    
//GLACE
    const GlaceObjects = map.getObjectLayer('Glace').objects;

    this.glaces = this.physics.add.group({
        immovable:true,
        allowGravity:false,
    });

    for(const glace of GlaceObjects){
            this.glaces.create(glace.x, glace.y, 'ice_cream')
                .setScale(0.1)
    }

    for (const glace of this.glaces.children.entries){
        this.physics.add.collider(glace, ground);
        this.physics.add.overlap(player, glace, Recolte_Glace, null, this);
    }

//POULET
    const PouletObjects = map.getObjectLayer('Poulet').objects;

    this.poulets = this.physics.add.group({
        immovable:true,
        allowGravity:false,
    });

    for(const poulet of PouletObjects){
            this.poulets.create(poulet.x, poulet.y, 'chicken')
                .setScale(0.1)
    }

    for (const poulet of this.poulets.children.entries){
        this.physics.add.collider(poulet, ground);
        this.physics.add.overlap(player, poulet, Recolte_Poulet, null, this);
    }
    
//ALIMENT 

    const AlimentObjects = map.getObjectLayer('Aliment').objects;

    this.aliments = this.physics.add.group({
        immovable:true,
        allowGravity:false,
    });

    for(const aliment of AlimentObjects){
        this.aliments.create(aliment.x, aliment.y,'food')
            .setScale(0.1)
    }

    for(const aliment of this.aliments.children.entries){
        this.physics.add.collider(aliment,ground);
        this.physics.add.overlap(player, aliment, Recolte_Aliment, null, this);
    }

//ENNEMIS 

    const EnnemiObjects = map.getObjectLayer('Ennemi').objects;

    this.ennemis = this.physics.add.group({
        immovable:true,
        allowGravity:false,
    });

    for(const ennemi of EnnemiObjects){
        this.ennemis.create(ennemi.x, ennemi.y,'ennemi')
            .setScale(0.1)
    }

    for(const ennemi of this.ennemis.children.entries){
        this.physics.add.collider(ennemi, ground);
        this.physics.add.collider(player, ennemi, Fonction_Ennemi, null, this);
    }

//BOULE DE FEU
    boules_de_feu = this.physics.add.group({
        allowGravity:true,
    });
            
    
    

//BOULE DE GLACE 
    boules_de_glace = this.physics.add.group({
        allowGravity:true,
    });
}

//CONTROLE 
function update ()
{
    
    player.update();
    onGround = player.body.blocked.down;
    roulade=false;
    player.setGravityY(300);
    if (gameOver)
    {
        return;
    }

    if (cursors.left.isUp && cursors.right.isUp && cursors.up.isUp && cursors.down.isUp)
    {
        player.setVelocityX(0);
    }

    if (cursors.left.isDown && Roulade.isDown && jauge>0)
    {
        roulade=true;
        player.setVelocityX(-500);
        jauge-=1;
        jaugeText.setText('Jauge: ' + jauge);
        
    }
    if(cursors.right.isDown && Roulade.isDown && jauge>0)
    {
        roulade=true;
        player.setVelocityX(500);
        jauge-=1;
        jaugeText.setText('Jauge: ' + jauge);
    }

    if (cursors.left.isDown && Roulade.isUp)
    {
        player.setVelocityX(-160);
        
    }
    if(cursors.right.isDown && Roulade.isUp)
    {
        player.setVelocityX(160);
    }
      
    if (cursors.up.isDown && onGround==true || Jump.isDown && onGround==true)
    {
        player.setVelocityY(-160);
    }
    if (cursors.up.isDown && Touche_Caisse==true || Jump.isDown && Touche_Caisse==true)
    {
        Touche_Caisse=false;
        player.setVelocityY(-160);
    }

    if(cursors.down.isDown)
    {
        player.setVelocityY(160);    
    }

    if (Competence_Speciale.isDown)
    {
        if(Buta_Feu==true && BDF_reload==true)
        {
            lancer_boule_de_feu(player);
            this.physics.add.collider(boules_de_feu, ground, destroyFireball, null, this);
            this.physics.add.overlap(boules_de_feu, this.ennemis, Kill_Ennemi, null, this);
            this.physics.add.overlap(boules_de_feu, this.caisses, destroyBox, null, this);
            
        }       
    }

    if (Competence_Speciale.isDown)
    {
        if(Buta_Glace==true && BDG_reload==true)
        {
            lancer_boule_de_glace(player);
            this.physics.add.collider(boules_de_glace, ground, destroyIceball, null, this);
            this.physics.add.overlap(boules_de_glace, this.ennemis, Gele_Ennemi, null, this);
        }       
    }
    if (Competence_Speciale.isDown)
    {
        if(Buta_Aile==true)
        {
            player.setGravity(0);
            if(cursors.down.isDown)
            {
                player.setVelocityY(160);    
            }
            if (cursors.up.isDown)
            {
                player.setVelocityY(-160);
            }
        }       
    }
    if (player_hp == 4){
                full_heart_5.setVisible(false);
                empty_heart_5.setVisible(true);
            }
            else if (player_hp == 3){
                full_heart_5.setVisible(false);
                empty_heart_5.setVisible(true);
                full_heart_4.setVisible(false);
                empty_heart_4.setVisible(true);
            }
            else if (player_hp == 2){
                full_heart_5.setVisible(false);
                empty_heart_5.setVisible(true);
                full_heart_4.setVisible(false);
                empty_heart_4.setVisible(true);
                full_heart_3.setVisible(false);
                empty_heart_3.setVisible(true);
            }
            else if (player_hp == 1){
                full_heart_5.setVisible(false);
                empty_heart_5.setVisible(true);
                full_heart_4.setVisible(false);
                empty_heart_4.setVisible(true);
                full_heart_3.setVisible(false);
                empty_heart_3.setVisible(true);
                full_heart_2.setVisible(false);
                empty_heart_2.setVisible(true);
            }
            else if (player_hp == 0){
                full_heart_5.setVisible(false);
                empty_heart_5.setVisible(true);
                full_heart_4.setVisible(false);
                empty_heart_4.setVisible(true);
                full_heart_3.setVisible(false);
                empty_heart_3.setVisible(true);
                full_heart_2.setVisible(false);
                empty_heart_2.setVisible(true);
                full_heart_1.setVisible(false);
                empty_heart_1.setVisible(true);
            }    
        if(movement==true){
            this.ennemis.setVelocityX(100);    
        }
        else if(movement==false){
            this.ennemis.setVelocityX(0);
        }

        if(doublesaut==true)
        {
        const isJumpJustDownup = Phaser.Input.Keyboard.JustDown(cursors.up)         
        
        if (isJumpJustDownup && (onGround || jumpCount < 2))
        {
            player.setVelocityY(-160);
            jumpCount++
        }

        if (onGround && !isJumpJustDownup)
        {
            jumpCount = 0
        }     
        
    }
        if (cursors.up.isDown && jump==true || Jump.isDown && jump==true)
        {
            player.setVelocityY(-160);
        }
}

///////////////////////////////////////
///////FONCTIONS SPECIALS SKILLS///////
///////////////////////////////////////

function lancer_boule_de_feu(player){ 
        var boule_de_feu = boules_de_feu.create(player.x, player.y-15,'boule_de_feu')
        .setGravityY(0)
        .setScale(0.1)


        var directionFireballPlayer = Math.round(Phaser.Math.Between(0,1))

        if(cursors.left.isDown){
            directionFireballPlayer=-400;
            playerDirection="left";
        }
        else if(cursors.right.isDown){
            directionFireballPlayer=400;
            playerDirection="right";
        }
        else if(cursors.right.isUp && cursors.left.isUp && cursors.up.isUp && directionFireballPlayer==1){
            directionFireballPlayer=400;
        }
        else if(cursors.right.isUp && cursors.left.isUp && cursors.up.isUp && directionFireballPlayer==0){
            directionFireballPlayer=-400;
        }

        if(playerDirection=="right"){
            boule_de_feu.setVelocity(400, 0);   
        }

        else if(playerDirection=="left"){
            boule_de_feu.setVelocity(-400, 0);
        }
        Competence_Speciale.reset();    
        BDF_reload=false;   
    }

function lancer_boule_de_glace(player){
        var boule_de_glace = boules_de_glace.create(player.x, player.y-15, 'boule_de_glace')
        .setGravityY(0)
        .setScale(0.1)

        var directionIceBallPlayer = Math.round(Phaser.Math.Between(0,1))
        
        if(cursors.left.isDown){
            directionIceBallPlayer=-400;
            playerDirection="left";
        }
        else if(cursors.right.isDown){
            directionIceBallPlayer=400;
            playerDirection="right";
        }
        else if(cursors.right.isUp && cursors.left.isUp && cursors.up.isUp && directionIceBallPlayer==1){
            directionIceBallPlayer=400;
        }
        else if(cursors.right.isUp && cursors.left.isUp && cursors.up.isUp && directionIceBallPlayer==0){
            directionIceBallPlayer=-400;
        }

        if(playerDirection=="right"){
            boule_de_glace.setVelocity(400, 0);
        }

        else if(playerDirection=="left"){
            boule_de_glace.setVelocity(-400, 0);
        }
        Competence_Speciale.reset();
        BDG_reload=false;
    }

function destroyFireball(boules_de_feu, ground){
        boules_de_feu.destroy();
        BDF_reload=true;
        } 

function destroyIceball(boules_de_glace, ground){
        boules_de_glace.destroy();
        BDG_reload=true;
        }
///////////////////////////////////////
/////FIN FONCTIONS SPECIALS SKILLS/////
///////////////////////////////////////

function hitByPlayer(player, caisse)
{
    Touche_Caisse=true;
    if(roulade==true){
        caisse.destroy();
    }
}

function destroyBox(boules_de_feu, caisse)
{
    console.log("test");
    caisse.destroy();
    boules_de_feu.destroy();
    BDF_reload=true;
}
///////////////////////////////////////
//////FONCTIONS RECOLTES ELEMENTS//////
///////////////////////////////////////

function Recolte_Piment(player, piment)
{
    piment.destroy();
    Buta_Feu=true;
    Buta_Glace=false;
    Buta_Aile=false;
}

function Recolte_Glace(player, glace)
{
    glace.destroy();
    Buta_Glace=true;
    Buta_Feu=false;
    Buta_Aile=false;
}

function Recolte_Poulet(player,poulet)
{
    poulet.destroy();
    Buta_Aile=true;
    Buta_Feu=false;
    Buta_Glace=false;
}

function Recolte_Aliment(player,aliment)
{
    aliment.destroy();
    jauge += 10;
    jaugeText.setText('Jauge: ' + jauge);
}
///////////////////////////////////////
////FIN FONCTIONS RECOLTES ELEMENTS////
///////////////////////////////////////

function Fonction_Ennemi(player,ennemi)
{
    if (invincible == false){
        player_hp = player_hp - 1;
        invincible = true;
        if (player_hp<=0){
            player_hp=0;
            this.physics.pause();
        }   
        setTimeout(function(){invincible = false}, 1000);
    }
    //REGROUPER JumpReset ET FONCTION_ENNEMI
    //if()
}

function Kill_Ennemi(boules_de_feu,ennemi)
{
    ennemi.destroy();
    boules_de_feu.destroy();
    BDF_reload=true;
}

function Gele_Ennemi(boules_de_glace,ennemi)
{
    boules_de_glace.destroy();
    BDG_reload=true;
    BDG_Touch=true;  
    if(movement==true && BDG_Touch==true){
        movement=false
        damageOff=false;
        this.time.delayedCall(timeoutDelayMovementEnnemi, endStopMovement, null, this);

    }
}

function endStopMovement(){
    movement=true;
    damageOff=true;
}

function JumpReset(player, ennemi){
    console.log("jump");
    doublesaut=true;
    jump=true;
}


</script>

</body>
</html>